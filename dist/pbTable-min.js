'use strict';var pbuf=require('protobufjs'),Root=pbuf.Root,Reader=pbuf.Reader,Writer=pbuf.Writer,types={string:'string',uint:'int32',int:'sint32',float:'float'},headProto={TableHeader:{nested:{Transform:{fields:{offset:{id:1,rule:'optional',type:'int32'},multip:{id:2,rule:'optional',type:'int32'},decimals:{id:3,rule:'optional',type:'int32'},sequence:{id:4,rule:'optional',type:'bool'}}},Field:{fields:{name:{id:1,rule:'required',type:'string'},type:{id:2,rule:'required',type:'string'},transform:{id:3,rule:'optional',type:'Transform'}}},Meta:{fields:{filename:{id:1,rule:'optional',type:'string'},owner:{id:2,rule:'optional',type:'string'},link:{id:3,rule:'optional',type:'string'},comment:{id:4,rule:'optional',type:'string'}}},Header:{fields:{header:{id:1,rule:'repeated',type:'Field'},meta:{id:2,rule:'optional',type:'Meta'}}}}}},protocolFromHeader=function(a,b){var c={DataArray:{nested:{Row:{fields:{}},Data:{fields:{data:{id:3,rule:'repeated',type:'Row'}}}}}},d={};a.header.forEach(function(a,b){var c=types[a.type];d[a.name]={id:b+1,type:c,rule:a.rule||'optional'}}),c.DataArray.nested.Row.fields=d;var e=new Root;e.addJSON(c),b(null,e)},decodeData=function(a,b,c){var d=a.lookupType('DataArray.Data'),e=d.decode(b);c(null,e)},encodeData=function(a,b,c,d){var e=a.lookupType('DataArray.Data'),f=e.verify(b);if(f){console.log('error encoding: ',b);var g=new Error(f);d(g)}else c||(c=new Writer),e.encode(b,c),d(null,c)},decodeHeader=function(a,b){var c=new Root;c.addJSON(headProto);var d=c.lookupType('TableHeader.Header'),e=d.decodeDelimited(a);b(null,e)},encodeHeader=function(a,b,c){var d=new Root;d.addJSON(headProto);var e=d.lookupType('TableHeader.Header'),f=e.verify(a);if(f){var g=new Error(f);c(g)}else b||(b=new Writer),e.encodeDelimited(a,b),c(null,b)},indexData=function(a,b){for(var c=[],d=a.pos;d<a.len;){var e=a.uint32();if(2==(7&e)||3==e>>>3){c.push(d);var f=a.uint32();d=a.pos+f,d<a.len&&a.skip(f)}else{var g=new Error('getIndex() Unexpected message type');return b(g)}}b(null,c)},decodeRow=function(a,b,c,d){var e,f=b.pos,g=0,h=null;for(Array.isArray(c)&&(e=[]);f<b.len;){var i=b.uint32();if(2==(7&i)||3==i>>>3){if(Array.isArray(c)){var j=!1;c.forEach(function(c,d){if(g===c){j=!0;var h=b.bytes(),i=a.lookupType('DataArray.Row');e[d]=i.decode(h),f=b.pos}})}else if(g===c){var k=b.bytes(),l=a.lookupType('DataArray.Row');return e=l.decode(k),d(null,e)}if(!j){var m=b.uint32();f=b.pos+m,f<b.len&&b.skip(m)}g++}else return h=new Error('getRow() Unexpected message type'),d(h)}return e?void d(null,e):(h=new Error('getRow() buffer only contains '+g+' rows'),d(h))},transformInteger={parse:function parse(a,b,c){a||(a=0),c.offset||(c.offset=0),c.multip||(c.multip=1),c.decimals||(c.decimals=0),a-=c.sequence&&b?b:c.offset;var d=a*c.multip;return d*=Math.pow(10,c.decimals),parseInt(d)},recover:function recover(a,b,c){a||(a=0),c.offset||(c.offset=0),c.multip||(c.multip=1),c.decimals||(c.decimals=0);var d=a*Math.pow(10,-c.decimals);return d/=c.multip,d+=c.sequence&&b?b:c.offset,d}},encodeVerbose=function(a,b){if(!a.header||!a.data){var c=new Error('object is not a valid format');return b(c)}encodeHeader(a,null,function(c,d){return c?b(c):void protocolFromHeader(a,function(c,e){if(c)return b(c);var f=JSON.parse(JSON.stringify(a));a.header.forEach(function(b){b.transform&&('int'===b.type||'uint'===b.type)&&f.data.forEach(function(c,d){var e=c[b.name],g=null;1<=d&&(g=a.data[d-1][b.name]);var h=transformInteger.parse(e,g,b.transform);f.data[d][b.name]=h})}),encodeData(e,f,d,function(a,c){if(a)return b(a);var d=c.finish();b(null,d)})})})},decodeVerbose=function(a,b){var c=new Reader(a);decodeHeader(c,function(a,d){return a?b(a):void protocolFromHeader(d,function(a,e){return a?b(a):void decodeData(e,c,function(a,c){if(a)return b(a);var e=JSON.parse(JSON.stringify(d));e.data=[],c.data.forEach(function(a,b){e.data[b]={},d.header.forEach(function(c){var d=a[c.name];if(c.transform&&('int'===c.type||'uint'===c.type)){var f=null;1<=b&&(f=e.data[b-1][c.name]),d=transformInteger.recover(d,f,c.transform)}e.data[b][c.name]=d})}),b(null,JSON.parse(JSON.stringify(e)))})})})},getVerbose=function(a,b,c){var d=new Reader(a);decodeHeader(d,function(a,e){return a?c(a):void protocolFromHeader(e,function(a,f){return a?c(a):void decodeRow(f,d,b,function(a,b){if(a)return c(a);var d;return Array.isArray(b)?(d=[],b.forEach(function(b,f){d[f]={},e.header.forEach(function(e){if(b[e.name]){var g=b[e.name];if(e.transform&&('int'===e.type||'uint'===e.type)){if(e.transform.sequence)return a=new Error('getVerbose(): cannot extract specific entries from sequenced data'),c(a);g=transformInteger.recover(g,null,e.transform)}d[f][e.name]=g}})})):(d={},e.header.forEach(function(e){if(b[e.name]){var f=b[e.name];if(e.transform&&('int'===e.type||'uint'===e.type)){if(e.transform.sequence)return a=new Error('getVerbose(): cannot extract specific entries from sequenced data'),c(a);f=transformInteger.recover(f,null,e.transform)}d[e.name]=f}})),c(null,d)})})})},addVerbose=function(a,b,c){decodeHeader(a,function(d,e){return d?c(d):void protocolFromHeader(e,function(d,e){return d?c(d):void encodeData(e,{data:b},null,function(b,d){if(b)return c(b);var e=d.finish(),f=a.length+e.length,g=new Uint8Array(f);g.set(a,0),g.set(e,a.length),c(null,g)})})})},encodeTable=function(a,b){var c;return a.header&&a.data?Array.isArray(a.data)?void encodeHeader(a,null,function(c,d){return c?b(c):void protocolFromHeader(a,function(c,e){if(c)return b(c);a.data.forEach(function(c,f){var g={data:[{}]};a.header.forEach(function(b,d){var e=c[d];if(b.transform&&('int'===b.type||'uint'===b.type)){var h=null;1<=f&&(h=a.data[f-1][d]),e=transformInteger.parse(e,h,b.transform)}g.data[0][b.name]=e}),encodeData(e,g,d,function(a){if(a)return b(a)})});var f=d.finish();b(null,f)})}):(c=new Error('object is not an array'),b(c)):(c=new Error('object is not a valid format'),b(c))},decodeTable=function(a,b){var c=new Reader(a);decodeHeader(c,function(a,d){return a?b(a):void protocolFromHeader(d,function(a,e){return a?b(a):void decodeData(e,c,function(a,c){if(a)return b(a);var e=JSON.parse(JSON.stringify(d));e.data=[],c.data.forEach(function(a,b){e.data[b]=[],d.header.forEach(function(c,d){var f=a[c.name];if(c.transform&&('int'===c.type||'uint'===c.type)){f||(f=0);var g=null;1<=b&&(g=e.data[b-1][d]),f=transformInteger.recover(f,g,c.transform)}e.data[b][d]=f})}),b(null,e)})})})},getTable=function(a,b,c){var d=new Reader(a);decodeHeader(d,function(a,e){return a?c(a):void protocolFromHeader(e,function(a,f){return a?c(a):void decodeRow(f,d,b,function(a,b){if(a)return c(a);var d=[];return Array.isArray(b)?b.forEach(function(b,f){d[f]=[],e.header.forEach(function(e,g){if(b[e.name]){var h=b[e.name];if(e.transform&&('int'===e.type||'uint'===e.type)){if(e.transform.sequence)return a=new Error('getTable(): cannot extract specific entries from sequenced data'),c(a);h=transformInteger.recover(h,null,e.transform)}d[f][g]=h}})}):e.header.forEach(function(e,f){if(b[e.name]){var g=b[e.name];if(e.transform&&('int'===e.type||'uint'===e.type)){if(e.transform.sequence)return a=new Error('getTable(): cannot extract specific entries from sequenced data'),c(a);g=transformInteger.recover(g,null,e.transform)}d[f]=g}}),c(null,d)})})})},addTable=function(a,b,c){decodeHeader(a,function(d,e){return d?c(d):void protocolFromHeader(e,function(d,f){if(d)return c(d);var g=new Writer;b.forEach(function(a){var b=[{}];a.forEach(function(a,c){b[0][e.header[c].name]=a}),encodeData(f,b,g,function(a){if(a)return c(a)})});var h=g.finish(),i=a.length+h.length,j=new Uint8Array(i);j.set(a,0),j.set(h,a.length),c(null,j)})})},getIndex=function(a,b){var c=new Reader(a),d=c.uint32(),e=null;return c.pos+d<c.len?void(c.skip(d),indexData(c,function(a,c){return a?a:b(null,c)})):(e=new Error('getIndex(): invalid buffer'),b(e))};module.exports={encodeVerbose:encodeVerbose,decodeVerbose:decodeVerbose,getVerbose:getVerbose,addVerbose:addVerbose,encodeTable:encodeTable,decodeTable:decodeTable,getTable:getTable,addTable:addTable,encode:encodeTable,decode:decodeTable,get:getTable,add:addTable,getIndex:getIndex};
